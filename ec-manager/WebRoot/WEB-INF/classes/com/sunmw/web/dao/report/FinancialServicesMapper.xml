<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sunmw.web.dao.report.FinancialServicesMapper">
	<resultMap id="TaobaoAccountHeadResultMap" type="com.sunmw.web.domain.report.TaobaoAccountHead">
		<!--
			WARNING - @mbggenerated This element is automatically generated by
			MyBatis Generator, do not modify.
		-->
		<id column="account_id" property="accountId" jdbcType="INTEGER" />
		<result column="month" property="month" jdbcType="VARCHAR" />
		<result column="store_id" property="storeId" jdbcType="INTEGER" />
		<result column="company_id" property="companyId" jdbcType="INTEGER" />
		<result column="price_amount" property="priceAmount" jdbcType="DECIMAL" />
		<result column="price_discount" property="priceDiscount"
			jdbcType="DECIMAL" />
		<result column="received_amount" property="receivedAmount"
			jdbcType="DECIMAL" />
		<result column="alipay_received_amount" property="alipayReceivedAmount"
			jdbcType="DECIMAL" />
		<result column="alipay_received_percentage" property="alipayReceivedPercentage"
			jdbcType="DECIMAL" />
		<result column="alipay_diff" property="alipayDiff" jdbcType="DECIMAL" />
		<result column="receive_post_fee_amount" property="receivePostFeeAmount"
			jdbcType="DECIMAL" />
		<result column="total_fee_amount" property="totalFeeAmount"
			jdbcType="DECIMAL" />
		<result column="alipay_total_fee_amount" property="alipayTotalFeeAmount"
			jdbcType="DECIMAL" />
		<result column="total_alipay_received_percentage" property="totalAlipayReceivedPercentage"
			jdbcType="DECIMAL" />
		<result column="alipay_total_diff" property="alipayTotalDiff"
			jdbcType="DECIMAL" />
		<result column="sale_item_cost" property="saleItemCost"
			jdbcType="DECIMAL" />
		<result column="sale_cost" property="saleCost" jdbcType="DECIMAL" />
		<result column="gross_margin" property="grossMargin" jdbcType="DECIMAL" />
		<result column="item_gross_margin_percentage" property="itemGrossMarginPercentage"
			jdbcType="DECIMAL" />
		<result column="sale_gross_margin_percentage" property="saleGrossMarginPercentage"
			jdbcType="DECIMAL" />
		<result column="point_amount" property="pointAmount" jdbcType="DECIMAL" />
		<result column="credit_card_amount" property="creditCardAmount"
			jdbcType="DECIMAL" />
		<result column="tb_commission_amount" property="tbCommissionAmount"
			jdbcType="DECIMAL" />
		<result column="post_fee_amount" property="postFeeAmount"
			jdbcType="DECIMAL" />
		<result column="tbke_commission_amount" property="tbkeCommissionAmount"
			jdbcType="DECIMAL" />
		<result column="consumables_amount" property="consumablesAmount"
			jdbcType="DECIMAL" />
		<result column="point_percentage" property="pointPercentage"
			jdbcType="DECIMAL" />
		<result column="tb_commission_percentage" property="tbCommissionPercentage"
			jdbcType="DECIMAL" />
		<result column="credit_card__percentage" property="creditCardPercentage"
			jdbcType="DECIMAL" />
		<result column="tbke_commission_percentage" property="tbkeCommissionPercentage"
			jdbcType="DECIMAL" />
		<result column="alipay_end_time" property="alipayEndTime"
			jdbcType="TIMESTAMP" />
		<result column="income" property="income" jdbcType="DECIMAL" />
		<result column="withdraw" property="withdraw" jdbcType="DECIMAL" />
		<result column="surplus" property="surplus" jdbcType="DECIMAL" />
		<result column="ctime" property="ctime" jdbcType="TIMESTAMP" />
	</resultMap>
	<sql id="TaobaoAccountHead_Example_Where_Clause">
		<!--
			WARNING - @mbggenerated This element is automatically generated by
			MyBatis Generator, do not modify.
		-->
		<where>
			<foreach collection="oredCriteria" item="criteria" separator="or">
				<if test="criteria.valid">
					<trim prefix="(" suffix=")" prefixOverrides="and">
						<foreach collection="criteria.criteria" item="criterion">
							<choose>
								<when test="criterion.noValue">
									and ${criterion.condition}
                </when>
								<when test="criterion.singleValue">
									and ${criterion.condition} #{criterion.value}
								</when>
								<when test="criterion.betweenValue">
									and ${criterion.condition} #{criterion.value}
									and
									#{criterion.secondValue}
                </when>
								<when test="criterion.listValue">
									and ${criterion.condition}
									<foreach collection="criterion.value" item="listItem"
										open="(" close=")" separator=",">
										#{listItem}
                  </foreach>
								</when>
							</choose>
						</foreach>
					</trim>
				</if>
			</foreach>
		</where>
	</sql>
	<sql id="TaobaoAccountHead_Column_List">
		<!--
			WARNING - @mbggenerated This element is automatically generated by
			MyBatis Generator, do not modify.
		-->
		account_id, month, store_id, company_id, price_amount, price_discount,
		received_amount,
		alipay_received_amount, alipay_received_percentage,
		alipay_diff, receive_post_fee_amount,
		total_fee_amount,
		alipay_total_fee_amount,
		total_alipay_received_percentage,
		alipay_total_diff,
		sale_item_cost, sale_cost, gross_margin,
		item_gross_margin_percentage,
		sale_gross_margin_percentage,
		point_amount, credit_card_amount, tb_commission_amount,
		post_fee_amount,
		tbke_commission_amount,
		consumables_amount,
		point_percentage, tb_commission_percentage, credit_card__percentage,
		tbke_commission_percentage, alipay_end_time, income, withdraw,
		surplus, ctime
	</sql>
	<select id="selectTaobaoAccountHeadByExample" resultMap="TaobaoAccountHeadResultMap"
		parameterType="com.sunmw.web.domain.report.ExpandTaobaoAccountHeadExample">
		<!--
			WARNING - @mbggenerated This element is automatically generated by
			MyBatis Generator, do not modify.
		-->
		select
		<if test="distinct">
			distinct
    </if>
		<include refid="TaobaoAccountHead_Column_List" />
		from taobao_account_head
		<if test="_parameter != null">
			<include refid="TaobaoAccountHead_Example_Where_Clause" />
		</if>
		<if test="orderByClause != null">
			order by ${orderByClause}
    </if>
		<if test="limit != null">
			limit ${limit}
    </if>
	</select>

	<select id="updateTaobaoAccountDetailAlipayFee" parameterType="java.util.Map">
		<!--
      	更新TaobaoAccountDetail的支付宝总额、差异和时间
    -->
		update taobao_account_detail a,
		(select tid,sum(amount_received)
		amount_received,max(alipay_time) alipay_time
		from
		alipay_financial_detail where store_id = ${StoreId} and
		account_type='交易付款' 
<!--		and alipay_time >='${AlipayFromDate}' and-->
<!--		alipay_time &lt; '${AlipayEndDate}'-->
		group by tid) b
		set a.alipay_fee =
		b.amount_received,a.alipay_time =
		b.alipay_time,a.alipay_fee_diff =
		b.amount_received-a.payment
		where a.tid = b.tid and a.account_id =
		${AccountId}
	</select>
	<select id="updateTaobaoAccountDetailCreditCardFee"
		parameterType="java.util.Map">
		<!--
      	更新TaobaoAccountDetail的支付宝信用卡费用
    -->
		update taobao_account_detail a,
		(select tid,sum(amount_paid)
		credit_card_fee from alipay_financial_detail
		where store_id =
		${StoreId} and account_type='收费' 
<!--		and alipay_time-->
<!--		>='${AlipayFromDate}'-->
<!--		and alipay_time &lt; '${AlipayEndDate}'-->
		group by tid) b
		set
		a.credit_card_fee = b.credit_card_fee*-1
		where a.tid = b.tid and
		a.account_id = ${AccountId}
	</select>
	<select id="updateTaobaoAccountDetailPointFee" parameterType="java.util.Map">
		<!--
      	更新TaobaoAccountDetail的支付宝积分
    -->
		update taobao_account_detail a,
		(select tid,sum(amount_paid) point_fee
		from alipay_financial_detail where
		store_id = ${StoreId} and
		account_type='返点积分' 
<!--		and alipay_time-->
<!--		>='${AlipayFromDate}' and-->
<!--		alipay_time &lt; '${AlipayEndDate}'-->
		group by tid) b
		set a.point_fee =
		b.point_fee*-1
		where a.tid = b.tid and a.account_id = ${AccountId}
	</select>
	<select id="updateTaobaoAccountDetailTbCommissionFee"
		parameterType="java.util.Map">
		<!--
      	更新TaobaoAccountDetail的支付宝佣金
    -->
		update taobao_account_detail a,
		(select tid,sum(amount_paid)
		tb_commission_fee from alipay_financial_detail
		where store_id =
		${StoreId} and account_type='B2COnLine服务' 
<!--		and-->
<!--		alipay_time-->
<!--		>='${AlipayFromDate}' and alipay_time &lt;-->
<!--		'${AlipayEndDate}'-->
		group by
		tid) b
		set a.tb_commission_fee = b.tb_commission_fee*-1
		where a.oid =
		b.tid and a.account_id = ${AccountId}
	</select>
	<select id="updateTaobaoAccountDetailTbkeCommissionFee"
		parameterType="java.util.Map">
		<!--
      	更新TaobaoAccountDetail的淘宝客佣金
    -->
		update taobao_account_detail a,
		(select tid,sum(amount_paid)
		tbke_commission_fee from alipay_financial_detail
		where store_id =
		${StoreId} and account_type='淘宝客佣金' 
<!--		and alipay_time-->
<!--		>='${AlipayFromDate}' and alipay_time &lt; '${AlipayEndDate}'-->
		group by
		tid) b
		set a.tbke_commission_fee = b.tbke_commission_fee*-1
		where a.tid
		= b.tid and a.account_id = ${AccountId}
	</select>
	<select id="updateTaobaoAccountDetailCurrentMonthRefund"
		parameterType="java.util.Map">
		<!--
      	更新TaobaoAccountDetail的当月退款
    -->
		update taobao_account_detail o
		inner join (select tid,sum(refund_amt)
		refund_amt from
		taobao_account_refund where account_id = ${AccountId}
		group by tid) r
		on o.tid = r.tid set current_month_refund=r.refund_amt
		where
		account_id = ${AccountId}
	</select>
	<select id="updateTaobaoAccountDetailOtherMonthRefund"
		parameterType="java.util.Map">
		<!--
      	更新TaobaoAccountDetail的次月退款
    -->
		update taobao_account_detail o
		inner join (select r.tid,sum(r.refund_amt) refund_amt from
		taobao_account_refund r inner join taobao_account_head h on
		r.account_id = h.account_id where h.store_id = ${StoreId} and
		r.account_id != ${AccountId} group by tid) r
		on o.tid = r.tid set other_month_refund=r.refund_amt where account_id =
		${AccountId}
	</select>
	<resultMap id="TaobaoAccountHeadAmtResultMap" type="java.util.Map">
		<result column="tb_commission_fee" property="tbCommissionFee"
			jdbcType="DECIMAL" />
		<result column="order_amt" property="orderAmt" jdbcType="DECIMAL" />
		<result column="post_fee" property="postFee" jdbcType="DECIMAL" />
		<result column="payment" property="payment" jdbcType="DECIMAL" />
		<result column="alipay_fee" property="alipayFee" jdbcType="DECIMAL" />
		<result column="point_fee" property="pointFee" jdbcType="DECIMAL" />
		<result column="tbke_commission_fee" property="tbkeCommissionFee"
			jdbcType="DECIMAL" />
		<result column="credit_card_fee" property="creditCardFee"
			jdbcType="DECIMAL" />
		<result column="wms_post_fee" property="wmsPostFee" jdbcType="DECIMAL" />
		<result column="cost_amt" property="costAmt" jdbcType="DECIMAL" />
		<result column="current_month_refund" property="currentMonthRefund" jdbcType="DECIMAL" />
		<result column="other_month_refund" property="otherMonthRefund" jdbcType="DECIMAL" />
		<result column="alipay_time" property="alipayEndTime" jdbcType="TIMESTAMP" />
		<result column="order_num" property="orderNum" jdbcType="INTEGER" />
		<result column="refund_num" property="refundNum" jdbcType="INTEGER" />
		<result column="order_item_num" property="orderItemNum" jdbcType="INTEGER" />
		<result column="refund_item_num" property="refundItemNum" jdbcType="INTEGER" />
		<result column="subtotal" property="subtotal" jdbcType="DECIMAL" />
		<result column="refund_fee" property="refundFee" jdbcType="DECIMAL" />
	</resultMap>
	<select id="selectTaobaoAccountDetailAmount" resultMap="TaobaoAccountHeadAmtResultMap"
		resultType="java.util.Map" parameterType="java.util.Map">
		<!--
      	查询明细合计金额
    -->
		select sum(tb_commission_fee) tb_commission_fee,sum(order_amt)
		order_amt,sum(post_fee) post_fee,sum(payment) payment,sum(alipay_fee)
		alipay_fee,sum(point_fee) point_fee,sum(tbke_commission_fee)
		tbke_commission_fee,sum(credit_card_fee)
		credit_card_fee,sum(wms_post_fee) wms_post_fee,sum(cost_amt) cost_amt,
    sum(current_month_refund) current_month_refund,sum(other_month_refund) other_month_refund,max(alipay_time) alipay_time,count(*) order_num,
    (select count(*) from (select count(*)  from taobao_account_refund where account_id = ${AccountId}) r) refund_num,
    (select sum(num) from taobao_account_refund where account_id = ${AccountId}) refund_item_num,sum(order_item_num) order_item_num,sum(subtotal) subtotal,
    (select sum(refund_amt) from taobao_account_refund where account_id = ${AccountId}) refund_fee
		from
		(select sum(tb_commission_fee)
		tb_commission_fee,order_amt,post_fee,payment,alipay_fee,point_fee,tbke_commission_fee,credit_card_fee,wms_post_fee,sum(cost_amt)
		cost_amt,current_month_refund,other_month_refund,max(alipay_time) alipay_time,count(*) order_num,sum(num) order_item_num,sum(subtotal) subtotal
		FROM taobao_account_detail
		where account_id = ${AccountId}
		group by
		tid,order_amt,post_fee,payment,alipay_fee,point_fee,tbke_commission_fee,credit_card_fee,wms_post_fee,current_month_refund,other_month_refund)
		a

	</select>

	<resultMap id="AlipayOtherAmountResultMap" type="java.util.Map">
		<result column="account_type" property="accountType" jdbcType="VARCHAR" />
		<result column="amount_received" property="amountReceived"
			jdbcType="DECIMAL" />
		<result column="amount_paid" property="amountPaid" jdbcType="DECIMAL" />
	</resultMap>
	<select id="selectAlipayOtherAmount" resultMap="AlipayOtherAmountResultMap"
		resultType="java.util.Map" parameterType="java.util.Map">
		<!--
      	查询支付宝未匹配金额
    -->
		SELECT account_type,sum(amount_received)
		amount_received,sum(amount_paid) amount_paid
		FROM
		alipay_financial_detail
		where (tid is null or length(tid)=0) and
		store_id = ${StoreId} and
		alipay_time >= '${AlipayFromDate}' and
		alipay_time &lt;
		'${AlipayEndDate}'
		group by account_type
	</select>
</mapper>